# Evaluation Tests

This document describes the experiments performed in our evaluation, making the process reproducible. After running each of these experiments, we extracted the generated log files to [logs directory](./logs/) and analyzed them through the source code in the [data_analysis directory](./data_analysis/), producing the tables and plots in the [results directory](./results/).

**To run the evaluation source code** with the current logs and generate the results of all our experiments, please run the following command from this directory: `python3 data_analysis`

> Note 1: This commands assume your key pair files are named `reference-architecture.pem` (**EU-WEST-1**) and `reference-architecture-us.pem`  (**US-EAST-1**).
> Note 2: Please follow the execution instructions on the [main README](../README.md) to create and setup the instances and S3 buckets necessary for each experiment.

## Single Client
Used to compare the baseline with the prototype.

**Environment**:
- Push/Pull Rate of 5ms
- t4g.small/ubuntu/arm instances (1 for each compute node and 1 for each client/load generator)
- Local region eu-west-1, Remote region us-east-1
- 1 partition
- Single key ("a") per read

### Goodput & Write Response Time
A single client issues write requests in closed loop. A single client issues read requests at constant rate.

**Configuration**:
- Average of 3 iterations
- Read clients read for 20s one key at a time
- 50/100/200 ms inter-read delay

#### Prototype
**Read Node**: `./readNode.sh final-goodput 1 8080 1`  
**Busy Write Generator**: `./busyWriteGenerator.sh final-goodput 1 1 8080 <readIp> 8080 <writeIp> 1 a`  
**Constant Read Generator**: `./constantReadGenerator.sh final-goodput 1 1 8080 <readIp> 8080 <writeIp> 1 <delay> 20000 1 a`  
**Write Node**: `./writeNode.sh final-goodput 1 8080 1 8080 <readIp>`  

#### Baseline
**Busy Write Generator**: `./evBusyWriteGenerator.sh final 1 a`  
**Constant Read Generator**: `./evConstantReadGenerator.sh final 1 <delay> 20000 a`  

#### Get logs
1. Compile the log JSON objects generated by the `ConstantReadGenerator` in a json array and save it in a `readclient-eu-west-1.json`. 
2. Go to the [./logs/single_client/goodput/](./logs/single_client/goodput/) directory, find the directory of the system you are running (`causal` or `eventual`) and, inside that directory, the subdirectory that corresponds to the inter-read delay you are testing (e.g., `d_50` for 50 ms). 
3. Replace the file in that directory.

### Read Latency
A single client issues read requests in closed loop. A single client issues write requests at constant rate.

**Configuration**:
- 50/100/200 ms inter-write delay ()
- 110 pushes in the CC prototype (11000, 5500 and 1100 writes), 110 writes in the EC baseline

#### Prototype
**Read Node**: `./readNode.sh final 1 8080 1`  
**Constant Write Generator**: `./constantWriteGenerator.sh final 1 1 8080 <readIp> 8080 <writeIp> 1 <delay> <writes> a`  
**Busy Read Generator**: `./busyReadGenerator.sh final 1 1 8080 <readIp> 8080 <writeIp> 1 <writes> 1 a`  
**Write Node**: `./writeNode.sh final 1 8080 1 8080 <readIp>`  

#### Baseline
**Constant Write Generator**: `./evConstantWriteGenerator.sh final 1 <delay> 110 a`  
**Busy Read Generator**: `./evBusyReadGenerator.sh final 1 110 a`  

#### Get Logs
1. In the `BusyReadGenerator` instance, use `docker container cp busyReadGenerator:/logs/ .` to extract the logs from the container.
2. Use `scp -i "reference-architecture.pem" -r ubuntu@<readDns>.eu-west-1.compute.amazonaws.com:~/logs ./logs-ref-arch`, where `dns` is the instance's DNS address, to extract them to your machine.
3. Locate the directory in the [./logs/single_client/read_latency/](./logs/single_client/read_latency/) that corresponds to the system you used (`causal` or `eventual`) and, inside that directory, the subdirectory that corresponds to the inter-write delay you are testing (e.g., `d_50` for 50 ms). 
4. Move the generated log from the `.logs-ref-arch` folder of your computer's home directory to the directory indicated above.

### Visibility
A single client issues read requests in closed loop. A single client issues write requests at constant rate.

**Configuration**:
- 110 writes
- 50/100/200 ms inter-write delay

#### Prototype
##### EU-WEST-1 (Local)
**Read Node**: `./readNode.sh final-visibility 1 8080 1`  
**Constant Write Generator**: `./constantWriteGenerator.sh final-visibility 1 1 8080 <readEuIp> 8080 <writeIp> 1 <delay> 110 a`  
**Busy Read Generator**: `./busyReadGenerator.sh final-visibility 1 1 8080 <readEuIp> 8080 <writeIp> 1 110 1 a`  
**Write Node**: `./writeNode.sh final-visibility 1 8080 1 8080 <readEuIp> 8080 <readUsIp>`  

##### US-EAST-1 (Remote)  
**Read Node**: `./readNode.sh final-visibility 1 8080 1`  
**Busy Read Generator**: `./busyReadGenerator.sh final-visibility 1 1 8080 <readUsIp> 8080 <writeIp> 1 110 1 a`  

#### Baseline
##### EU-WEST-1
**Constant Write Generator**: `./evConstantWriteGenerator.sh final 1 <delay> 110 a`  
**Busy Read Generator**: `./evBusyReadGenerator.sh final 1 110 a`  

##### US-EAST-1
**Busy Read Generator**: `./evBusyReadGenerator.sh final 1 110 a`  

#### Get Logs
1. Extract the logs from each container:
    - **BusyReadGenerator**: `docker container cp busyReadGenerator:/logs/ .`  
    - **ConstantWriteGenerator**: `docker container cp constantWriteGenerator:/logs/ .`  
    - **ReadNode**: `docker container cp readNode:/logs/ .`  
    - **WriteNode**: `docker container cp writeNode:/logs/ .`  
2. Extract the logs from each instance by replacing the `dns` with the instance's DNS address: 
    - **EU-WEST-1**: `scp -i "reference-architecture.pem" -r ubuntu@<dns>.eu-west-1.compute.amazonaws.com:~/logs ./logs-ref-arch`  
    - **US-EAST-1**: `scp -i "reference-architecture-us.pem" -r ubuntu@<dns>.compute-1.amazonaws.com:~/logs ./logs-ref-arch`  
3. Locate the directory in the [./logs/single_client/visibility/](./logs/single_client/visibility/) that corresponds to the system you used (`causal` or `eventual`) and, inside that directory, the subdirectory that corresponds to the inter-write delay you are testing (e.g., `d_50` for 50 ms). 
4. Move the generated logs from the `.logs-ref-arch` folder of your computer's home directory to the directory indicated above.

## Multiple Clients
Used to study the scalability, performance and staleness of the causally consistent prototype with multiple clients, partitions and read nodes.

**Environment**:
- Push/Pull Rate of 5ms
- t4g.small/ubuntu/arm instances (1 for each compute node)
- c6g.8xlarge/ubuntu/arm instances (for the client processes)
- Local region eu-west-1, Remote region us-east-1
- 8 keys

### Read Latency + Visibility
Multiple clients issue read requests in closed loop. Multiple clients issue write requests at constant rate.

#### Change number of readers and writers

**Configuration**:
- 50ms inter-write delay 
- Readers-Writers tests: R1-W2, R5-W10, R10-W20, R16-W32 (16R + 3W / 29W), R19-R38 (19R + 9W / 29W)
- 1000 writes per client
- Read for 60s in EU (Local Region) and 90s in US (Remote Region)
- 2 keys per read

##### EU-WEST-1
**Read Node**: `./readNode.sh final-visibility 1 8080 1`  
**Write Node**: `./writeNode.sh final-visibility 1 8080 1 8080 <readEuIp> 8080 <readUsIp>`  
**Read Client**: `./multiBusyReadGenerator.sh final-visibility 1 1 1 8080 <readEuIp> 8080 <writeIp> 1 60000 2 8 <R>`  
**Write Client**: `./multiConstantWriteGenerator.sh final-visibility 1 1 8080 <readEuIp> 8080 <writeIp> 1 50 1000 8 <W>`  

##### US-EAST-1
**Read Node**: `./readNode.sh final-visibility 1 8080 1`  
**Read Client**: `./multiBusyReadGenerator.sh final-visibility 1 1 1 8080 <readUsIp> 8080 <writeIp> 1 90000 2 8 <R>`  

#### Change number of partitions

**Configuration**:
- 50ms inter-write delay 
- 5 readers and 10 writers
- 1000 writes per client
- Read for 60s in EU (Local Region)
- 2 keys per read
- 1, 2 and 4 partitions (for 1 the results from the last test was used)

##### 2 partitions
**Read Nodes**: `./readNode.sh final-visibility 2 8080 1 2`  
**Write Nodes**:   
- **eu**: `./writeNode.sh final-visibility 2 8080 1 8080 <readEuIp> 8080 <readUsIp>`  
- **us**: `./writeNode.sh final-visibility 2 8080 2 8080 <readEuIp> 8080 <readUsIp>`  
**Read Client EU**: `./multiBusyReadGenerator.sh final-visibility 2 1 2 8080 <readEuIp> 8080 <writeIp1> 1 8080 <writeIp2> 2 60000 2 4 5`  
**Write Client EU**: `./multiConstantWriteGenerator.sh final-visibility 2 2 8080 <readEuIp> 8080 <writeIp1> 1 8080 <writeIp2> 2 50 1000 4 10`   
**Read Client US**: `./multiBusyReadGenerator.sh final-visibility 2 1 2 8080 <readUsIp> 8080 <writeIp1> 1 8080 <writeIp2> 2 60000 2 4 5`    

##### 4 partitions
**Read Nodes**: `./readNode.sh final-visibility 4 8080 1 2 3 4`  
**Write Nodes**:  
- **eu**: `./writeNode.sh final-visibility 4 8080 1 8080 <readEuIp> 8080 <readUsIp>`  
- **us**: `./writeNode.sh final-visibility 4 8080 2 8080 <readEuIp> 8080 <readUsIp>`  
- **eu**: `./writeNode.sh final-visibility 4 8080 3 8080 <readEuIp> 8080 <readUsIp>`  
- **us**: `./writeNode.sh final-visibility 4 8080 4 8080 <readEuIp> 8080 <readUsIp>`  

**Read Client EU**: `./multiBusyReadGenerator.sh final-visibility 4 1 4 8080 <readEuIp> 8080 <writeIp1> 1 8080 <writeIp2> 2 8080 <writeIp3> 3 8080 <writeIp4> 4 60000 2 2 5`  
**Write Client EU**: `./multiConstantWriteGenerator.sh final-visibility 4 4 8080 <readEuIp> 8080 <writeIp1> 1 8080 <writeIp2> 2 8080 <writeIp3> 3 8080 <writeIp4> 4 50 1000 2 10`  
**Read Client US**: `./multiBusyReadGenerator.sh final-visibility 4 1 4 8080 <readUsIp> 8080 <writeIp1> 1 8080 <writeIp2> 2 8080 <writeIp3> 3 8080 <writeIp4> 4 60000 2 2 5`

#### Get Logs
1. Extract the logs from each container:
    - **BusyReadGenerator**: `docker container cp multiBusyReadGenerator:/logs/ .` (EU and US)  
    - **ConstantWriteGenerator**: `docker container cp multiConstantWriteGenerator:/logs/ .`  
    - **ReadNode**: `docker container cp readNode:/logs/ .` (EU and US)  
    - **WriteNode**: `docker container cp writeNode:/logs/ .`   
2. Extract the logs from each instance by replacing the `dns` with the instance's DNS address:   
    - **EU-WEST-1**: `scp -i "reference-architecture.pem" -r ubuntu@<dns>.eu-west-1.compute.amazonaws.com:~/logs ./logs-ref-arch`  
    - **US-EAST-1**: `scp -i "reference-architecture-us.pem" -r ubuntu@<dns>.compute-1.amazonaws.com:~/logs ./logs-ref-arch`  
3. Locate the directory in the [./logs/multi_client/read_times/partitions](./logs/multi_client/read_times/partitions) that corresponds to the number of partitions you used and, inside that directory, the subdirectory that corresponds to the read/write ratio that you are testing (e.g., `p1/r5_w10` for 1 partition,5 readers and 10 writers). 
4. Move the generated logs from the `.logs-ref-arch` folder of your computer's home directory to the directory indicated above.

### Read Throughput
Multiple clients issue read requests in closed loop. Multiple clients issue write requests at constant rate.

**Configuration**
- 50ms inter-write delay
- 10 fixed writers
- 500 writes per writer
- Variable number of read nodes (1, 2, 3, 4)
- For each number of nodes, variable number of readers (1, 5, 10, 15, 20, 25)
- 2 keys read at a time during 30 seconds
- Read for 30s

#### Change number of read nodes and readers
**Read Node**: `./readNode.sh final 1 8080 1`  
**Write Node**:  
    **1**: `./writeNode.sh final 1 8080 1 8080 <readIp1>`  
    **2**: `./writeNode.sh final 1 8080 1 8080 <readIp1> 8080 <readIp2>`  
    **3**: `./writeNode.sh final 1 8080 1 8080 <readIp1> 8080 <readIp2> 8080 <readIp3>`  
    **4**: `./writeNode.sh final 1 8080 1 8080 <readIp1> 8080 <readIp2> 8080 <readIp3> 8080 <readIp4>`  
**Read Client**:   
    **1**: `./multiBusyReadGenerator.sh final 1 1 1 8080 <readIp1> 8080 <writeIp> 1 30000 2 8 1`  
    **2**: `./multiBusyReadGenerator.sh final 1 2 1 8080 <readIp1> 8080 <readIp2> 8080 <writeIp> 1 30000 2 8 <R>`  
    **3**: `./multiBusyReadGenerator.sh final 1 3 1 8080 <readIp1> 8080 <readIp2> 8080 <readIp3> 8080 <writeIp> 1 30000 2 8 <R>`  
    **4**: `./multiBusyReadGenerator.sh final 1 4 1 8080 <readIp1> 8080 <readIp2> 8080 <readIp3> 8080 <readIp4> 8080 <writeIp> 1 30000 2 8 <R>`  

**Write Client**: `./multiConstantWriteGenerator.sh final 1 1 8080 <readEuIp1> 8080 <writeIp> 1 50 500 8 10`  

#### Get Logs
1. Extract the logs from the container:
    - **BusyReadGenerator**: `docker container cp multiBusyReadGenerator:/logs/ .` 
2. Extract the logs from each instance by replacing the `dns` with the instance's DNS address: 
    `scp -i "reference-architecture.pem" -r ubuntu@<dns>.eu-west-1.compute.amazonaws.com:~/logs ./logs-ref-arch`
3. Locate the directory in the [./logs/multi_client/read_times/read_nodes](./logs/multi_client/read_times/read_nodes) that corresponds to the number of read nodes you used and, inside that directory, the subdirectory that corresponds to the number of reading clients (e.g., `n2/r5` for 2 read nodes and 5 readers). 
4. Move the generated logs from the `.logs-ref-arch` folder of your computer's home directory to the directory indicated above.

### Write Throughput
Multiple clients issue write requests in closed loop to a set of keys.

**Configuration**
- 50ms inter-write delay
- Variable number of writes nodes / partitions (1, 2, 4)
- For each number of nodes, variable number of writers (1, 5, 10, 15, 20, 25)
- Writers issue writes during 30s 

#### 1 partition
**Write Node**: `./writeNode.sh final 1 8080 1 8080 <readIp>`  
**Write Client**: `./multiBusyWriteGenerator.sh final 1 1 8080 <readIp> 8080 <writeIp1> 1 8 <W> 30000`  

#### 2 partitions
**Write Nodes**:  
    `./writeNode.sh final 2 8080 1 8080 <readIp>`  
    `./writeNode.sh final 2 8080 2 8080 <readIp>`  
**Write Client**: `./multiBusyWriteGenerator.sh final 2 2 8080 <readIp> 8080 <writeIp1> 1 8080 <writeIp2> 2 4 <W> 30000`  

#### 4 partitions
**Write Nodes**:   
    `./writeNode.sh final 4 8080 1 8080 <readIp>`  
    `./writeNode.sh final 4 8080 2 8080 <readIp>`  
    `./writeNode.sh final 4 8080 3 8080 <readIp>`  
    `./writeNode.sh final 4 8080 4 8080 <readIp>`  
**Write Client**: `./multiBusyWriteGenerator.sh final 4 4 8080 <readIp> 8080 <writeIp1> 1 8080 <writeIp2> 2 8080 <writeIp3> 3 8080 <writeIp4> 4 2 <W> 30000`

#### Get Logs
1. Extract the logs from the container:
    - **BusyWriteGenerator**: `docker container cp multiBusyWriteGenerator:/logs/ .`
2. Extract the logs from each instance by replacing the `dns` with the instance's DNS address: 
    `scp -i "reference-architecture.pem" -r ubuntu@ec2-3-252-94-165.eu-west-1.compute.amazonaws.com:~/logs ./logs-ref-arch`
3. Locate the subdirectory in the [./logs/multi_client/write_throughput/ directory](./logs/multi_client/read_times/read_nodes) that corresponds to the number of partitions you used and, inside that directory, the subdirectory that corresponds to the number of writing clients (e.g., `p2/w5` for 2 partitions and 5 writers). 
4. Move the generated logs from the `.logs-ref-arch` folder of your computer's home directory to the directory indicated above.
